---
// src/components/Contact/CountdownOffer.astro
import Button from "@components/Button/Button.astro";
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
}
const { class: className } = Astro.props;

const WHATSAPP_NUMBER_OFERTA = "573059074783";
const CODIGO_CUPON = "EXCLUSIVOCONGLAM";
const DESCUENTO = "15%";
const MENSAJE_WHATSAPP_OFERTA = `Hola Glam 5.0, ¬°tengo el cup√≥n ${CODIGO_CUPON} y quiero agendar mi cita!`;
const FECHA_FIN_OFERTA = new Date(2025, 11, 31, 23, 59, 59).getTime(); // Hasta fin de diciembre

const ofertaTitulo = "‚ú® Oferta Exclusiva Glam 5.0";
const ofertaDescripcion = `Presenta este cup√≥n en nuestra boutique y obt√©n un <strong>${DESCUENTO} de descuento</strong> en el alquiler de tu vestido o un accesorio <strong>GRATIS</strong>*.`;
const ofertaBotonTexto = "Agendar Cita por WhatsApp";
---

<section class:list={["relative overflow-hidden rounded-xl bg-gradient-to-br from-white via-gray-50 to-white dark:from-black dark:via-gray-900 dark:to-black p-8 md:p-12 shadow-2xl text-center border border-gray-200 dark:border-gray-800", className]}>
  <h2 class="text-2xl md:text-3xl font-serif font-semibold text-gray-900 dark:text-white mb-4 tracking-tight">{ofertaTitulo}</h2>

  <p class="text-base md:text-lg text-gray-700 dark:text-gray-300 mb-6 leading-relaxed max-w-xl mx-auto" set:html={ofertaDescripcion}></p>

  <!-- Cup√≥n Visual -->
  <div id="coupon-container" class="relative mx-auto max-w-md mb-8">
    <div class="coupon-card bg-gradient-to-r from-gray-100 via-white to-gray-100 dark:from-gray-800 dark:via-gray-900 dark:to-gray-800 border-2 border-dashed border-gray-400 dark:border-gray-600 rounded-xl p-6 shadow-lg">
      <!-- C√≠rculos decorativos para efecto de cup√≥n -->
      <div class="absolute -left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-white dark:bg-black rounded-full"></div>
      <div class="absolute -right-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-white dark:bg-black rounded-full"></div>
      
      <div class="flex flex-col items-center gap-3">
        <span class="text-xs uppercase tracking-widest text-gray-600 dark:text-gray-400 font-medium">Cup√≥n de Descuento</span>
        <div class="flex items-center gap-2">
          <span class="text-4xl">üéÅ</span>
          <span class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">{DESCUENTO}</span>
        </div>
        <div class="bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-4 py-2 rounded-lg font-mono text-lg md:text-xl tracking-wider font-bold">
          {CODIGO_CUPON}
        </div>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Muestra este cup√≥n en Glam 5.0 Pereira</p>
      </div>
    </div>
  </div>

  <!-- Countdown Timer -->
  <p class="text-sm text-gray-600 dark:text-gray-400 mb-3 font-medium">‚è∞ La oferta termina en:</p>
  <div id="countdown-timer" class="flex justify-center gap-3 mb-6 text-gray-900 dark:text-white">
    <div class="bg-white/80 dark:bg-gray-800/60 backdrop-blur p-3 rounded-lg shadow-md w-14 md:w-16 text-center">
      <span data-countdown="days" class="block text-xl md:text-2xl font-bold">00</span>
      <span class="text-[10px] font-light uppercase tracking-wide">D√≠as</span>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/60 backdrop-blur p-3 rounded-lg shadow-md w-14 md:w-16 text-center">
      <span data-countdown="hours" class="block text-xl md:text-2xl font-bold">00</span>
      <span class="text-[10px] font-light uppercase tracking-wide">Horas</span>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/60 backdrop-blur p-3 rounded-lg shadow-md w-14 md:w-16 text-center">
      <span data-countdown="minutes" class="block text-xl md:text-2xl font-bold">00</span>
      <span class="text-[10px] font-light uppercase tracking-wide">Min</span>
    </div>
    <div class="bg-white/80 dark:bg-gray-800/60 backdrop-blur p-3 rounded-lg shadow-md w-14 md:w-16 text-center">
      <span data-countdown="seconds" class="block text-xl md:text-2xl font-bold">00</span>
      <span class="text-[10px] font-light uppercase tracking-wide">Seg</span>
    </div>
  </div>

  <!-- Botones de Acci√≥n -->
  <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
    <!-- Bot√≥n Descargar Cup√≥n -->
    <button
      id="download-coupon-btn"
      class="w-full sm:w-auto px-6 py-3 bg-gray-900 hover:bg-gray-800 dark:bg-white dark:hover:bg-gray-100 text-white dark:text-gray-900 rounded-full text-base font-medium tracking-wide transition-all inline-flex items-center justify-center gap-2 shadow-lg"
    >
      <span>üì•</span>
      <span>Descargar Cup√≥n</span>
    </button>

    <!-- Bot√≥n WhatsApp -->
    <a
      href={`https://wa.me/${WHATSAPP_NUMBER_OFERTA}?text=${encodeURIComponent(MENSAJE_WHATSAPP_OFERTA)}`}
      target="_blank"
      rel="noopener noreferrer"
      class="w-full sm:w-auto elegant-pulse-button px-6 py-3 bg-black hover:bg-gray-800 dark:bg-gray-800 dark:hover:bg-gray-700 text-white border-2 border-black dark:border-gray-600 rounded-full text-base font-medium tracking-wide transition-all inline-flex items-center justify-center gap-2 shadow-lg"
    >
      <Icon name="socials/whatsapp" class="size-5" />
      <span>{ofertaBotonTexto}</span>
    </a>
  </div>

  <p class="text-xs text-gray-500 dark:text-gray-400 italic mt-6">*V√°lido en alquileres. Aplica t√©rminos y condiciones. Un cup√≥n por persona.</p>
</section>

<script is:inline>
  (function() {
    const FECHA_FIN = new Date(2025, 11, 31, 23, 59, 59).getTime();
    const CODIGO_CUPON = "EXCLUSIVOCONGLAM";
    const DESCUENTO = "15%";
    let intervalId = null;
    
    function updateCountdown() {
      const now = new Date().getTime();
      const distance = FECHA_FIN - now;

      const countdownElement = document.getElementById('countdown-timer');
      const daysEl = document.querySelector('[data-countdown="days"]');
      const hoursEl = document.querySelector('[data-countdown="hours"]');
      const minutesEl = document.querySelector('[data-countdown="minutes"]');
      const secondsEl = document.querySelector('[data-countdown="seconds"]');

      if (!daysEl || !hoursEl || !minutesEl || !secondsEl) {
        return;
      }

      if (distance < 0) {
        if (countdownElement) {
          countdownElement.innerHTML = "<p class='text-lg text-rose-500 font-medium'>¬°La oferta ha terminado!</p>";
        }
        const couponContainer = document.getElementById('coupon-container');
        const downloadBtn = document.getElementById('download-coupon-btn');
        const offerButton = document.querySelector('.elegant-pulse-button');
        if (couponContainer) couponContainer.style.opacity = '0.5';
        if (downloadBtn) downloadBtn.style.display = 'none';
        if (offerButton) offerButton.style.display = 'none';
        if (intervalId) clearInterval(intervalId);
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      daysEl.textContent = String(days).padStart(2, '0');
      hoursEl.textContent = String(hours).padStart(2, '0');
      minutesEl.textContent = String(minutes).padStart(2, '0');
      secondsEl.textContent = String(seconds).padStart(2, '0');
    }

    // Funci√≥n para generar y descargar el cup√≥n como imagen
    function downloadCoupon() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Tama√±o del cup√≥n (optimizado para m√≥vil)
      canvas.width = 800;
      canvas.height = 500;
      
      // Fondo con gradiente
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
      gradient.addColorStop(0, '#fce7f3');
      gradient.addColorStop(0.5, '#ffffff');
      gradient.addColorStop(1, '#fce7f3');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Borde punteado
      ctx.strokeStyle = '#ec4899';
      ctx.lineWidth = 4;
      ctx.setLineDash([10, 10]);
      ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
      
      // C√≠rculos decorativos (efecto cup√≥n)
      ctx.fillStyle = '#1f2937';
      ctx.beginPath();
      ctx.arc(0, canvas.height / 2, 25, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(canvas.width, canvas.height / 2, 25, 0, Math.PI * 2);
      ctx.fill();
      
      // Logo/Marca
      ctx.fillStyle = '#1f2937';
      ctx.font = 'bold 36px Georgia, serif';
      ctx.textAlign = 'center';
      ctx.fillText('‚ú® GLAM 5.0 ‚ú®', canvas.width / 2, 80);
      
      // Subt√≠tulo
      ctx.fillStyle = '#ec4899';
      ctx.font = '18px Arial, sans-serif';
      ctx.fillText('CUP√ìN DE DESCUENTO EXCLUSIVO', canvas.width / 2, 120);
      
      // Descuento grande
      ctx.fillStyle = '#1f2937';
      ctx.font = 'bold 100px Arial, sans-serif';
      ctx.fillText(DESCUENTO, canvas.width / 2, 230);
      
      // Texto "DE DESCUENTO"
      ctx.font = '24px Arial, sans-serif';
      ctx.fillText('DE DESCUENTO', canvas.width / 2, 270);
      
      // C√≥digo del cup√≥n
      ctx.fillStyle = '#1f2937';
      ctx.fillRect(canvas.width / 2 - 180, 300, 360, 60);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 32px monospace';
      ctx.fillText(CODIGO_CUPON, canvas.width / 2, 342);
      
      // Instrucciones
      ctx.fillStyle = '#6b7280';
      ctx.font = '16px Arial, sans-serif';
      ctx.fillText('Presenta este cup√≥n en Glam 5.0 Pereira', canvas.width / 2, 400);
      ctx.fillText('V√°lido hasta el 31 de Diciembre 2025', canvas.width / 2, 425);
      
      // T√©rminos
      ctx.font = '12px Arial, sans-serif';
      ctx.fillStyle = '#9ca3af';
      ctx.fillText('*Aplica t√©rminos y condiciones. Un cup√≥n por persona.', canvas.width / 2, 465);
      
      // Descargar
      const link = document.createElement('a');
      link.download = 'cupon-glam50-exclusivo.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function initCountdown() {
      updateCountdown();
      intervalId = setInterval(updateCountdown, 1000);
    }

    // Event listener para el bot√≥n de descarga
    const downloadBtn = document.getElementById('download-coupon-btn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', downloadCoupon);
    }

    // Iniciar el countdown inmediatamente
    initCountdown();
  })();
</script>

<style>
  .elegant-pulse-button {
    animation: softPulse 2s ease-in-out infinite;
  }

  @keyframes softPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.3); }
    70% { transform: scale(1.03); box-shadow: 0 0 15px 10px rgba(0, 0, 0, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
  }

  .coupon-card {
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
</style>
